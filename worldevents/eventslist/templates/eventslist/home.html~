{% extends "eventslist/base.html" %}
{% load staticfiles %}
{% block stylesheets %}
	<link rel="stylesheet" type="text/css" href={% static "css/base.css" %} >
{% endblock %}
{% block javascript %}
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" ></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src={% static "javascript/gmap3.min.js" %}></script>

{% endblock %}
{% block user %}
	{% if user.is_authenticated %}	
		<h2>{{user.username}}</h2>
	{% endif %}
{% endblock %}
{% block nav %}
<ul>
{% if user.is_authenticated %}	
	<li><a href="{% url 'eventslist.views.logoutpage' %}">Logout</a></li>
	<li><a class="form" href="{% url 'eventslist.views.addevent' %}">Add Event</a></li>
			
{% else %}
	<li><a class="form" href="{% url 'eventslist.views.register' %}">Registro</a></li>
	<li><a class="form" href="{% url 'eventslist.views.loginpage' %}">Login</a></li>

{% endif %}

	<li><a class="form" href="{% url 'eventslist.views.searchevents' %}">Search</a></li>
	
</ul>
{% endblock %}	

{% block content %}


	<div id="container">
	{% if event_list %}	
		<table>
		{% for event in event_list%}
			<tr>
				<td style="display:none;">{{ event.id }}</td>	
				<td style="display:none;">{{ event.location }}</td>				
				<td>{{ event.title }}</td>
				<td>{{ event.category }}</td>
			</tr>
		{% endfor %}
		</table>

		{% for event in event_list%}
		<ul class="event_detail" id="{{ event.id }}">
			<li>{{ event.title }}</li>
			<li>{{ event.description }}</li>
			<li>{{ event.category }}</li>
			{% if event.photo %}
				<li><img src="{% static "media/" %}{{ event.photo }}"></li>
			{% endif %}
			{% if user.is_authenticated and user.username == event.user%}
				<a class="form" href="{% url 'eventslist.views.editevent' %}/{{ event.id }}">Edit</a>
				<a class="form" href="{% url 'eventslist.views.deleteevent' %}/{{ event.id }}">Delete</a>
			{% endif %}
			<div class="comments">
			{% include "eventslist/comments.html" %}
			</div>
		</ul>
		{% endfor %}
		<div id="map_detail"></div>
	{% endif %}
	<div>
	<div id="form_container">
	</div>



{% endblock %}
{% block scripts %}
 <script type="text/javascript">
	$( document ).ready(init());

	function init() {
	red_icon="http://maps.google.com/mapfiles/ms/icons/red-dot.png"	  
	blue_icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
		



	$("#map_detail").gmap3({
          map:{
            options:{
              center:[46.578498,2.457275],
              zoom: 5
            }
          }
        });

	$("tr:first").addClass("selected_event")
	id=($(".selected_event").find("td:first").html())
	$("#"+id).toggle()

	
	
	addMarkers()
	
	$("a[href='comment']").on("click",function(e){
		e.preventDefault()
		if ($(this).text()=="Add comment"){
			$(this).text("Close")
			$(".event_detail[style='display: block;'] form").show()
			
		}else{
			$(this).text("Add comment")
			$(".event_detail[style='display: block;'] form").hide()
		}
		
	});


	$(".form").on("click",function(e){
		e.preventDefault()
		$("#form_container").load($(this).attr("href"),function(){
		show_form_container()
		});
		
		
	});
	
	$("ul.event_detail").on("submit","form",function(e){
		e.preventDefault();
		var postData = new FormData()
		
		$("textarea",this).add("input:not([type='submit'])",this).each(function(i) {
        		postData.append($(this).attr("name"), $(this).val());
		});
		postData.append("event_id",$("ul.event_detail[style='display: block;']").attr("id"))

		var formUrl = $(this).attr("action");

		$.ajax({
			url:formUrl,
			type:"POST",
			data:postData,
			processData: false,
			contentType: false,
			success:function(data,textStatus,jqXHR)
			{
				
				$("ul.event_detail[style='display: block;'] .comments").html(data);
			},
			error:function(jqXHR,textStatus,errorThrown)
			{alert(errorThrown)}
		});
	});

	$("#form_container").on("submit","form",function(e){
		e.preventDefault();
		//var postData = $(this).serializeArray();
		var postData = new FormData()
		$("#form_container form input[type='file']").each(function(i) {
			postData.append($(this).attr("name"), $(this).get(0).files[0]);
		});
		//postData.append("photo", $('#id_photo').get(0).files[0]);

    $("form textarea, form select, form input:not([type='submit']):not([name='photo'])").each(function(i) {
        postData.append($(this).attr("name"), $(this).val());
	
    });
	
		var formUrl = $(this).attr("action");
		$.ajax({
			url:formUrl,
			type:"POST",
			data:postData,
			processData: false,
			contentType: false,
			success:function(data,textStatus,jqXHR)
			{
				if (data.indexOf("<html>")!=-1){
					document.write(data)
					
				}else{
					$("#form_container").html(data);
					show_close_link()
				}
			},
			error:function(jqXHR,textStatus,errorThrown)
			{}
		});
		e.unBind();
	});
	

	$("tr").click(function(){
		map=$("#map_detail")
		id=($(".selected_event").find("td:first").html())
		lat=$(".selected_event").find("td:eq(1)").html().substring($(".selected_event").find("td:eq(1)").html().indexOf("[")+1,$(".selected_event").find("td:eq(1)").html().lastIndexOf(","))
		lng=$(".selected_event").find("td:eq(1)").html().substring($(".selected_event").find("td:eq(1)").html().lastIndexOf(",")+1,$(".selected_event").find("td:eq(1)").html().indexOf("]"))
		map.gmap3({clear:{tag:[id]}});
		addMarker(map,id,blue_icon,lat,lng)
		
		$("a[href='comment']").text("Add comment")
		$("#"+id+" form").hide()

		$("#"+id).toggle()
		$(".selected_event").removeClass("selected_event")
		$(this).addClass("selected_event")
		id=($(this).find("td:first").html())
		$("#"+id).toggle()
		lat=$(this).find("td:eq(1)").html().substring($(this).find("td:eq(1)").html().indexOf("[")+1,$(this).find("td:eq(1)").html().lastIndexOf(","))
		lng=$(this).find("td:eq(1)").html().substring($(this).find("td:eq(1)").html().lastIndexOf(",")+1,$(this).find("td:eq(1)").html().indexOf("]"))
		map.gmap3({clear:{tag:[id]}});
		addMarker(map,id,red_icon,lat,lng)
		map.gmap3("get").setCenter(new google.maps.LatLng(lat,lng))
	});





	
	}

function addMarkers(){
		map=$("#map_detail")
		$("tr").each(function(){
			
			lat=$(this).find("td:eq(1)").html().substring($(this).find("td:eq(1)").html().indexOf("[")+1,$(this).find("td:eq(1)").html().lastIndexOf(","))
			lng=$(this).find("td:eq(1)").html().substring($(this).find("td:eq(1)").html().lastIndexOf(",")+1,$(this).find("td:eq(1)").html().indexOf("]"))
			if ($(this).hasClass("selected_event")){	
				icon_image=red_icon		
			}else{
				icon_image=blue_icon
			}
			tag_label=($(this).find("td:first").html())
			
			addMarker(map,tag_label,icon_image,lat,lng)
		});	
	}


	function addMarker(map,tag_label,icon_image,lat,lng){
		map.gmap3({
				marker:{
					latLng:[lat,lng],
					tag:tag_label,
					options:{
						draggable:true,
						icon: icon_image
					}
				}
		});
	}

	function show_form_container()
	{	
		$("body").append("<div id='shade'></div>")
		$("#form_container").css("display","block")
		show_close_link()
		$("input[value='Cancel']").click(function(){
			$("#shade").remove();
			$("#form_container").html("");
		});	
		
	}

	function show_close_link()
	{
		$("#form_container").append("<div class='close'><a href='#'>X</a></div>");
		$(".close").click(function(){
			$("#shade").remove();
			$("#form_container").html("");
		});	
	}


	



</script>
{% endblock %}

